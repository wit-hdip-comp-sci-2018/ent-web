<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet'>
    <link href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/combine/npm/highlightjs@9.16.2,npm/jquery@3.4.1"></script>
    <script src="https://cdn.jsdelivr.net/combine/npm/highlightjs@9.16.2,npm/jquery@3.4.1,npm/jquery-address@1.6.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.js"></script>
    <link href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.17.1/build/styles/railscasts.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.17.1/build/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <style>
      

body {
  font-family: "Open Sans", "Helvetica", "Helvetica Neue",  "Arial", sans-serif;
  font-size:90%;
  color: black;
}

p {
  margin: 0.5em;
}

pre code {
  font-family: "Monaco";
  font-size: 100%;
}

img {
  box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
  margin:10px;
}

h1, h2, h3 {
  border-bottom:thin solid black;
  margin-bottom: 0.5em;
  margin-top: 1em;
}

h1 {
  font-style:italic;
  font-size:130%;
}

h2 {
  font-size:110%;
}

h3 {
  font-size:100%;
}



      

html, body {
  height: 100%;
  margin: 0;
}
.wrapper {
  height: 100%;
  display: flex;
  flex-direction: column;
}
.footer {
  background: white;
  text-align: right;
}
.content {
  flex: 1;
  overflow: auto;
}



    </style>
  </head>

  
  

  <div class="ui fixed top pointing inverted stackable menu labmenu">
    <header class="header item">
      <i id="toc" class="sitemap icon"></i>
      
        <a href="../../index.html"> Representational State Transfer  </a>
      
    </header>
    <div class="right tab-menu menu">
      
        <a class="item" data-tab="Lab 09b Rest">
          Lab 09b Rest
        </a>
      
        <a class="item" data-tab="Solutions">
          Solutions
        </a>
      
        <a class="item" data-tab="02">
          02
        </a>
      
        <a class="item" data-tab="03">
          03
        </a>
      
        <a class="item" data-tab="04">
          04
        </a>
      
        <a class="item" data-tab="05">
          05
        </a>
      
        <a class="item" data-tab="06">
          06
        </a>
      
        <a class="item" data-tab="07.Exercises">
          07.Exercises
        </a>
      
    </div>
  </div>


  

  <div class="ui pushable">
    <div class="ui inverted labeled icon left inline vertical sidebar menu">
      <br><br>
      
        
          
            <a class="item"
               href="/topic-01-js-client/unit-1/book-3-jquery/index.html">Lab 01a JQuery </a>
          
        
      
        
          
            <a class="item"
               href="/topic-01-js-client/unit-2/book-1-ajax-1/index.html">Lab 01b Github API </a>
          
        
      
        
          
            <a class="item"
               href="/topic-02-introducing-node/unit-1/book-1/index.html">Lab 02a FoureSquare API </a>
          
        
      
        
          
            <a class="item"
               href="/topic-02-introducing-node/unit-1/book-2/index.html">Lab 02b FoureSquare JS </a>
          
        
      
        
          
            <a class="item"
               href="/topic-02-introducing-node/unit-2/book-applications/index.html">Lab 02b Applications </a>
          
        
      
        
          
            <a class="item"
               href="/topic-03-hapi-apps/unit-1-views/book-views/index.html">Lab 03a Views </a>
          
        
      
        
          
            <a class="item"
               href="/topic-03-hapi-apps/unit-2-sessions/book-sessions/index.html">Lab 03b Sessions </a>
          
        
      
        
          
            <a class="item"
               href="/topic-04-mongo-db/unit-1/book-models/index.html">Lab 04a Models I </a>
          
        
      
        
          
            <a class="item"
               href="/topic-04-mongo-db/unit-2/book-1/index.html">Lab-04b Models II </a>
          
        
      
        
          
            <a class="item"
               href="/topic-05-deployment-seeding/unit-0-validation/book-1-validation/index.html">Lab 05a Validation </a>
          
        
      
        
          
            <a class="item"
               href="/topic-05-deployment-seeding/unit-1-deployment/book-2-deployment/index.html">Lab 05b Deployment </a>
          
        
      
        
          
            <a class="item"
               href="/topic-05-deployment-seeding/unit-2-db-seeding/book-seeding/index.html">Lab 05c Seeding </a>
          
        
      
        
          
            <a class="item"
               href="/topic-06-security-and-apis/unit-1-security-introduction/book-1-pgp-gpg/index.html">Lab 06a GPG </a>
          
        
      
        
          
            <a class="item"
               href="/topic-06-security-and-apis/unit-2-api/book-api/index.html">Lab 06b Apis </a>
          
        
      
        
          
            <a class="item"
               href="/topic-07-security-and-tdd/unit-1-security-foundations/book-1-openssl/index.html">Lab 07a OpenSSL and Certificates </a>
          
        
      
        
          
            <a class="item"
               href="/topic-07-security-and-tdd/unit-2-tdd/book-tdd/index.html">Lab 07b Tdd </a>
          
        
      
        
          
            <a class="item"
               href="/topic-08-tls-threats/unit-1-certificates+tls/book-1-tls-configuration/index.html">Lab 08a TLS </a>
          
        
      
        
          
            <a class="item"
               href="/topic-08-tls-threats/unit-2-webapp-threats+vulnerabilities/book-1-misuse-cases/index.html">Lab 08b Threat Modelling </a>
          
        
      
        
          
            <a class="item"
               href="/topic-09-authentication-rest/unit-1-web-app-authentication/book-1-web-authentication/index.html">Lab 09a Authentication techniques </a>
          
        
      
        
          
            <a class="item"
               href="/topic-09-authentication-rest/unit-2-rest/book-rest/index.html">Lab 09b Rest </a>
          
        
      
        
          
            <a class="item"
               href="/topic-10-pen-testing-aurelia-1/unit-1-pentesting/book-1-burp-proxy/index.html">Lab 10a Burp-Proxy </a>
          
        
      
        
          
            <a class="item"
               href="/topic-10-pen-testing-aurelia-1/unit-1-pentesting/book-2-regex/index.html">Lab 10b Regular Expressions </a>
          
        
      
        
          
            <a class="item"
               href="/topic-10-pen-testing-aurelia-1/unit-1-pentesting/book-3-xss/index.html">Lab 10c XSS tips </a>
          
        
      
        
          
            <a class="item"
               href="/topic-10-pen-testing-aurelia-1/unit-2-aurelia-a/book-au-1/index.html">Lab-10d Aurelia Components </a>
          
        
      
        
          
            <a class="item"
               href="/topic-10-pen-testing-aurelia-1/unit-2-aurelia-b/book-au-2/index.html">Lab 10e Aurelia Custom Elements </a>
          
        
      
        
          
            <a class="item"
               href="/topic-11-aurelia-2/unit-0-routers/book-au-3/index.html">Lab 11a Aurelia Router </a>
          
        
      
        
          
            <a class="item"
               href="/topic-11-aurelia-2/unit-1-services/book-au-4/index.html">Lab 11b Aurelia Services </a>
          
        
      
        
          
            <a class="item"
               href="/topic-11-aurelia-2/unit-2-events/book-au-5/index.html">Lab 11c Aurelia Event Aggregator </a>
          
        
      
        
          
            <a class="item"
               href="/topic-11-aurelia-2/unit-3-aurelia-authentication-1/book-au-6/index.html">Lab 11d User Models </a>
          
        
      
        
          
            <a class="item"
               href="/topic-11-aurelia-2/unit-3-aurelia-authentication-1/book-au-7/index.html">Lab 11e donation-client:donation-web </a>
          
        
      
        
          
            <a class="item"
               href="/topic-12-aurelia-3/unit-1/book-a-hapi-auth/index.html">Lab 12a Hapi-JWT </a>
          
        
      
        
          
            <a class="item"
               href="/topic-12-aurelia-3/unit-1/book-b-aurelia-jwt/index.html">Lab-12b Aurelia JWT </a>
          
        
      
        
          
            <a class="item"
               href="/topic-12-aurelia-3/unit-2/book-1-maps/index.html">Lab-12c Map Panel </a>
          
        
      
        
          
            <a class="item"
               href="/topic-12-aurelia-3/unit-2/book-2-maps-2/index.html">Lab-12d Map View </a>
          
        
      
        
          
            <a class="item"
               href="/topic-12-aurelia-3/unit-2/book-3-deployment/index.html">Lab-12e Deployment </a>
          
        
      
    </div>
    <div class="pusher" tabindex="-1">
      <div class="ui basic segment">
        <br>
        
          <div class="ui tab segment lab" data-tab="Lab 09b Rest">
            <h1>Objectives</h1>
<p>Extend the api to support creating and deleting donations. Donations are associated with candidates, so we utilise the url to establish this relationship.</p>

          </div>
        
          <div class="ui tab segment lab" data-tab="Solutions">
            <h1>Exercise Solutions</h1>
<h2>Exercise 2: Users API</h2>
<p>This is an extended set of fixture data for the test:</p>
<h2>test/fixtures.json</h2>
<pre><code>{
  &quot;donationService&quot;: &quot;http://localhost:3000&quot;,
  &quot;users&quot;: [
    {
      &quot;firstName&quot;: &quot;Homer&quot;,
      &quot;lastName&quot;: &quot;Simpson&quot;,
      &quot;email&quot;: &quot;homer@simpson.com&quot;,
      &quot;password&quot;: &quot;secret&quot;
    },
    {
      &quot;firstName&quot;: &quot;Marge&quot;,
      &quot;lastName&quot;: &quot;Simpson&quot;,
      &quot;email&quot;: &quot;marge@simpson.com&quot;,
      &quot;password&quot;: &quot;secret&quot;
    },
    {
      &quot;firstName&quot;: &quot;Bart&quot;,
      &quot;lastName&quot;: &quot;Simpson&quot;,
      &quot;email&quot;: &quot;bart@simpson.com&quot;,
      &quot;password&quot;: &quot;secret&quot;
    }
  ],
  &quot;candidates&quot;: [
    {
      &quot;firstName&quot;: &quot;Lisa&quot;,
      &quot;lastName&quot;: &quot;Simpson&quot;,
      &quot;office&quot;: &quot;President&quot;
    },
    {
      &quot;firstName&quot;: &quot;Donald&quot;,
      &quot;lastName&quot;: &quot;Simpson&quot;,
      &quot;office&quot;: &quot;President&quot;
    }
  ],
  &quot;newCandidate&quot;: {
    &quot;firstName&quot;: &quot;Barnie&quot;,
    &quot;lastName&quot;: &quot;Grumble&quot;,
    &quot;office&quot;: &quot;President&quot;
  },
  &quot;newUser&quot;: {
    &quot;firstName&quot;: &quot;Maggie&quot;,
    &quot;lastName&quot;: &quot;Simpson&quot;,
    &quot;email&quot;: &quot;maggie@simpson.com&quot;,
    &quot;password&quot;: &quot;secret&quot;
  }
}</code></pre>
<p>The Users API Implementation:</p>
<h2>app/api/users.js</h2>
<pre><code>&#39;use strict&#39;;

const Boom = require(&#39;boom&#39;);
const User = require(&#39;../models/user&#39;);

const Users = {

  find: {
    auth: false,
    handler: async function(request, h) {
      const users = await User.find();
      return users;
    }
  },

  findOne: {
    auth: false,
    handler: async function(request, h) {
      try {
        const user = await User.findOne({ _id: request.params.id });
        if (!user) {
          return Boom.notFound(&#39;No User with this id&#39;);
        }
        return user;
      } catch (err) {
        return Boom.notFound(&#39;No User with this id&#39;);
      }
    }
  },

  create: {
    auth: false,
    handler: async function(request, h) {
      const newUser = new User(request.payload);
      const user = await newUser.save();
      if (user) {
        return h.response(user).code(201);
      }
      return Boom.badImplementation(&#39;error creating user&#39;);
    }
  },

  deleteAll: {
    auth: false,
    handler: async function(request, h) {
      await User.deleteMany({});
      return { success: true };
    }
  },

  deleteOne: {
    auth: false,
    handler: async function(request, h) {
      const user = await User.deleteOne({ _id: request.params.id });
      if (user) {
        return { success: true };
      }
      return Boom.notFound(&#39;id not found&#39;);
    }
  }
};

module.exports = Users;</code></pre>
<p>New API Routes:</p>
<h2>routesapi.js</h2>
<pre><code>const Users= require(&#39;./app/api/users&#39;);

...

  { method: &#39;GET&#39;, path: &#39;/api/users&#39;, config: Users.find },
  { method: &#39;GET&#39;, path: &#39;/api/users/{id}&#39;, config: Users.findOne },
  { method: &#39;POST&#39;, path: &#39;/api/users&#39;, config: Users.create },
  { method: &#39;DELETE&#39;, path: &#39;/api/users/{id}&#39;, config: Users.deleteOne },
  { method: &#39;DELETE&#39;, path: &#39;/api/users&#39;, config: Users.deleteAll }</code></pre>
<p>Extend DonationService to support new API:</p>
<h2>test/donation-service.js</h2>
<pre><code>&#39;use strict&#39;;

const axios = require(&#39;axios&#39;);

class DonationService {
  constructor(baseUrl) {
    this.baseUrl = baseUrl;
  }

  async getUsers() {
    try {
      const response = await axios.get(this.baseUrl + &#39;/api/users&#39;);
      return response.data;
    } catch (e) {
      return null;
    }
  }

  async getUser(id) {
    try {
      const response = await axios.get(this.baseUrl + &#39;/api/users/&#39; + id);
      return response.data;
    } catch (e) {
      return null;
    }
  }

  async createUser(newUser) {
    try {
      const response = await axios.post(this.baseUrl + &#39;/api/users&#39;, newUser);
      return response.data;
    } catch (e) {
      return null;
    }
  }

  async deleteAllUsers() {
    try {
      const response = await axios.delete(this.baseUrl + &#39;/api/users&#39;);
      return response.data;
    } catch (e) {
      return null;
    }
  }

  async deleteOneUser(id) {
    try {
      const response = await axios.delete(this.baseUrl + &#39;/api/users/&#39; + id);
      return response.data;
    } catch (e) {
      return null;
    }
  }

  async getCandidates() {
    try {
      const response = await axios.get(this.baseUrl + &#39;/api/candidates&#39;);
      return response.data;
    } catch (e) {
      return null;
    }
  }

  async getCandidate(id) {
    try {
      const response = await axios.get(this.baseUrl + &#39;/api/candidates/&#39; + id);
      return response.data;
    } catch (e) {
      return null;
    }
  }

  async createCandidate(newCandidate) {
    try {
      const response = await axios.post(this.baseUrl + &#39;/api/candidates&#39;, newCandidate);
      return response.data;
    } catch (e) {
      return null;
    }
  }

  async deleteAllCandidates() {
    try {
      const response = await axios.delete(this.baseUrl + &#39;/api/candidates&#39;);
      return response.data;
    } catch (e) {
      return null;
    }
  }

  async deleteOneCandidate(id) {
    try {
      const response = await axios.delete(this.baseUrl + &#39;/api/candidates/&#39; + id);
      return response.data;
    } catch (e) {
      return null;
    }
  }
}

module.exports = DonationService;</code></pre>
<p>Finally, new tests:</p>
<h2>test/usersapitest.js</h2>
<pre><code>&#39;use strict&#39;;

const assert = require(&#39;chai&#39;).assert;
const DonationService = require(&#39;./donation-service&#39;);
const fixtures = require(&#39;./fixtures.json&#39;);
const _ = require(&#39;lodash&#39;);

suite(&#39;User API tests&#39;, function () {

  let users = fixtures.users;
  let newUser = fixtures.newUser;

  const donationService = new DonationService(fixtures.donationService);

  setup(async function () {
    await donationService.deleteAllUsers();
  });

  teardown(async function () {
    await donationService.deleteAllUsers();
  });

  test(&#39;create a user&#39;, async function () {
    const returnedUser = await donationService.createUser(newUser);
    assert(_.some([returnedUser], newUser), &#39;returnedUser must be a superset of newUser&#39;);
    assert.isDefined(returnedUser._id);
  });

  test(&#39;get user&#39;, async function () {
    const u1 = await donationService.createUser(newUser);
    const u2 = await donationService.getUser(u1._id);
    assert.deepEqual(u1, u2);
  });

  test(&#39;get invalid user&#39;, async function () {
    const u1 = await donationService.getUser(&#39;1234&#39;);
    assert.isNull(u1);
    const u2 = await donationService.getUser(&#39;012345678901234567890123&#39;);
    assert.isNull(u2);
  });


  test(&#39;delete a user&#39;, async function () {
    let u = await donationService.createUser(newUser);
    assert(u._id != null);
    await donationService.deleteOneUser(u._id);
    u = await donationService.getUser(u._id);
    assert(u == null);
  });

  test(&#39;get all users&#39;, async function () {
    for (let u of users) {
      await donationService.createUser(u);
    }

    const allUsers = await donationService.getUsers();
    assert.equal(allUsers.length, users.length);
  });

  test(&#39;get users detail&#39;, async function () {
    for (let u of users) {
      await donationService.createUser(u);
    }

    const allUsers = await donationService.getUsers();
    for (var i = 0; i &lt; users.length; i++) {
      assert(_.some([allUsers[i]], users[i]), &#39;returnedUser must be a superset of newUser&#39;);
    }
  });

  test(&#39;get all users empty&#39;, async function () {
    const allUsers = await donationService.getUsers();
    assert.equal(allUsers.length, 0);
  });

});</code></pre>
<p>This test should pass now.</p>
<p>Configure your IDE to run all tests in the tests folder like this:</p>
<p><img src="img/06.png" alt=""></p>
<p>This is the configuration for the above:</p>
<p><img src="img/07.png" alt=""></p>

          </div>
        
          <div class="ui tab segment lab" data-tab="02">
            <h1>Retrieve All Donations API</h1>
<p>Currently our api only supports candidate and user model access/update. What about donations?</p>
<p>We start with just retrieving donations:</p>
<h2>routesapi.js</h2>
<pre><code>...
const Donations = require(&#39;./app/api/donations&#39;);
...

  { method: &#39;GET&#39;, path: &#39;/api/donations&#39;, config: Donations.findAll }
...</code></pre>
<h2>api/donationsapi.js</h2>
<pre><code>&#39;use strict&#39;;

const Boom = require(&#39;boom&#39;);
const Donation = require(&#39;../models/donation&#39;);

const Donations = {
  findAll: {
    auth: false,
    handler: async function (request, h) {
      const donations = await Donation.find();
      return donations;
    }
  }
};

module.exports = Donations;</code></pre>
<p>We can use either a browser or postman to test this route:</p>
<ul>
<li><a href="http://localhost:4000/api/donations">http://localhost:4000/api/donations</a></li>
</ul>
<p><img src="img/01.png" alt=""></p>
<p>We are retrieving the seeded donations in the above.</p>
<p>It would be useful to write a test for this route also, but as we cannot yet make a donation the test will be of limited value. We will come back to this as soon as we figure out how making donations can be supported.</p>

          </div>
        
          <div class="ui tab segment lab" data-tab="03">
            <h1>Retrieving donations for a Candidate</h1>
<p>Donations are associated with candidates and donors. Using REST principles we imagine a simple path that could yield donations for a specific candidate:</p>
<ul>
<li><a href="http://localhost:4000/api/candidates/012345678901234567890123/donations">http://localhost:4000/api/candidates/012345678901234567890123/donations</a></li>
</ul>
<p>This could retrieve all donations for the candidate with the ID provided in the url.</p>
<p>This is the implementation:</p>
<h2>routesapi.js</h2>
<pre><code>  { method: &#39;GET&#39;, path: &#39;/api/candidates/{id}/donations&#39;, config: Donations.findByCandidate },</code></pre>
<h2>app/api/donations.js</h2>
<pre><code>  findByCandidate: {
    auth: false,
    handler: async function(request, h) {
      const donations = await Donation.find({ candidate: request.params.id });
      return donations;
    }
  }</code></pre>
<p>We can test using the browser (on the seeded data):</p>
<p><img src="img/02.png" alt=""></p>
<p>Or using Postman:</p>
<p><img src="img/08.png" alt=""></p>
<p><img src="img/09.png" alt=""></p>

          </div>
        
          <div class="ui tab segment lab" data-tab="04">
            <h1>Creating &amp; Deleting Donations</h1>
<p>Creating a donation, and associating it with a candidate, can be implemented using a similar pattern to retrieving donations for a candidate:</p>
<h2>routesapi.js</h2>
<pre><code>  { method: &#39;POST&#39;, path: &#39;/api/candidates/{id}/donations&#39;, config: Donations.makeDonation },</code></pre>
<p>We can define a route to delete all donations:</p>
<pre><code>  { method: &#39;DELETE&#39;, path: &#39;/api/donations&#39;, config: Donations.deleteAll }</code></pre>
<p>These are the implementations:</p>
<h2>app/api/donationsapi.js</h2>
<pre><code>...
const Candidate = require(&#39;../models/candidate&#39;)
...

const Donations = {
  ...

  makeDonation: {
    auth: false,
    handler: async function(request, h) {
      let donation = new Donation(request.payload);
      const candidate = await Candidate.findOne({ _id: request.params.id });
      if (!candidate) {
        return Boom.notFound(&#39;No Candidate with this id&#39;);
      }
      donation.candidate = candidate._id;
      donation = await donation.save();
      return donation;
    }
  },

  deleteAll: {
    auth: false,
    handler: async function(request, h) {
      await Donation.deleteMany({});
      return { success: true };
    }
  }</code></pre>
<p>We could test these using Postman - but instead we will proceed to develop some unit tests instead (next step).</p>

          </div>
        
          <div class="ui tab segment lab" data-tab="05">
            <h1>Preparing to test the Donations API</h1>
<p>We can extend the fixtures.json to include some donation objects for test purposes:</p>
<h2>test/fixtures.json</h2>
<pre><code>...
  &quot;donations&quot;: [
    {
      &quot;amount&quot;: 40,
      &quot;method&quot;: &quot;paypal&quot;
    },
    {
      &quot;amount&quot;: 90,
      &quot;method&quot;: &quot;direct&quot;
    },
    {
      &quot;amount&quot;: 430,
      &quot;method&quot;: &quot;paypal&quot;
    }
  ],
...</code></pre>
<p>And then we can start to scaffold up our tests. They have a common structure:</p>
<h2>test/donationsapitest.js</h2>
<pre><code>&#39;&#39;use strict&#39;;

const assert = require(&#39;chai&#39;).assert;
const DonationService = require(&#39;./donation-service&#39;);
const fixtures = require(&#39;./fixtures.json&#39;);
const _ = require(&#39;lodash&#39;);

suite(&#39;Donation API tests&#39;, function () {

  let donations = fixtures.donations;
  let newCandidate = fixtures.newCandidate;

  const donationService = new DonationService(fixtures.donationService);

  setup(async function () {
  });

  teardown(async function () {
  });

  test(&#39;a test function&#39;, function () {

  });
});</code></pre>
<p>Before composing the tests, we need to extend <code>DonationService</code> to support additional features:</p>
<h2>donation-service.js</h2>
<pre><code>  async makeDonation(id, donation) {
    try {
      const response = axios.post(&#39;/api/candidates/&#39; + id + &#39;/donations&#39;, donation);
      return repsonse.data;
    } catch (e) {
      return null;
    }
  }

  async getDonations(id) {
    try {
      const response = await axios.get(&#39;/api/candidates/&#39; + id + &#39;/donations&#39;);
      return repsonse.data;
    } catch (e) {
      return null;
    }
  }

  async deleteAllDonations() {
    try {
      const response = await axios.delete(&#39;/api/donations&#39;);
      return repsonse.data;
    } catch (e) {
      return null;
    }
  }</code></pre>

          </div>
        
          <div class="ui tab segment lab" data-tab="06">
            <h1>Donations API Tests</h1>
<p>Here are a first set of tests:</p>
<h2>test/donationsapitest.js</h2>
<pre><code>&#39;use strict&#39;;

const assert = require(&#39;chai&#39;).assert;
const DonationService = require(&#39;./donation-service&#39;);
const fixtures = require(&#39;./fixtures.json&#39;);
const _ = require(&#39;lodash&#39;);

suite(&#39;Donation API tests&#39;, function() {
  let donations = fixtures.donations;
  let newCandidate = fixtures.newCandidate;

  const donationService = new DonationService(fixtures.donationService);

  setup(async function() {
    donationService.deleteAllCandidates();
    donationService.deleteAllDonations();
  });

  teardown(async function() {});

  test(&#39;create a donation&#39;, async function() {
    const returnedCandidate = await donationService.createCandidate(newCandidate);
    await donationService.makeDonation(returnedCandidate._id, donations[0]);
    const returnedDonations = await donationService.getDonations(returnedCandidate._id);
    assert.equal(returnedDonations.length, 1);
    assert(_.some([returnedDonations[0]], donations[0]), &#39;returned donation must be a superset of donation&#39;);
  });

  test(&#39;create multiple donations&#39;, async function() {
    const returnedCandidate = await donationService.createCandidate(newCandidate);
    for (var i = 0; i &lt; donations.length; i++) {
      await donationService.makeDonation(returnedCandidate._id, donations[i]);
    }

    const returnedDonations = await donationService.getDonations(returnedCandidate._id);
    assert.equal(returnedDonations.length, donations.length);
    for (var i = 0; i &lt; donations.length; i++) {
      assert(_.some([returnedDonations[i]], donations[i]), &#39;returned donation must be a superset of donation&#39;);
    }
  });

  test(&#39;delete all donations&#39;, async function() {
    const returnedCandidate = await donationService.createCandidate(newCandidate);
    for (var i = 0; i &lt; donations.length; i++) {
      await donationService.makeDonation(returnedCandidate._id, donations[i]);
    }

    const d1 = await donationService.getDonations(returnedCandidate._id);
    assert.equal(d1.length, donations.length);
    await donationService.deleteAllDonations();
    const d2 = await donationService.getDonations(returnedCandidate._id);
    assert.equal(d2.length, 0);
  });
});</code></pre>
<p>These tests should run successfully now.</p>
<p>We now have a comprehensive set of tests:</p>
<p><img src="img/03.png" alt=""></p>

          </div>
        
          <div class="ui tab segment lab" data-tab="07.Exercises">
            <h1>Exercises</h1>
<p>Archive of the project so far:</p>
<ul>
<li><a href="https://github.com/wit-hdip-comp-sci-2018/donation-web/releases/tag/donation.11.end">https://github.com/wit-hdip-comp-sci-2018/donation-web/releases/tag/donation.11.end</a></li>
</ul>
<h2>Exercise 1: Delete Donations for a Candidate</h2>
<p>Introduce a route to support deleting of donations for a single candidate.</p>
<h2>Exercise 2: Test Delete Donations</h2>
<p>Write unit tests to exercise the new delete donations feature.</p>
<h2>Exercise 3: Donor Support</h2>
<p>Currently we leave the <code>donor</code> property of each donation empty, at least when using the api. This is clearly incomplete, as donor are faithfully recorded if the Web UI is engaged.</p>
<ul>
<li>How is the donor identified via the Web UI?</li>
<li>How might we record donors using the API? </li>
</ul>

          </div>
        
      </div>
    </div>
  </div>


  <br>
  <script>
    $(document).on('keydown', function(e) {
  e = e || window.event;
  var nextTab;
  switch (e.which || e.keyCode) {
    case 37: // left
      nextTab = $('.tab-menu a[data-tab].active').prev('a[data-tab]');
      if (!nextTab.length) nextTab = $('.tab-menu a[data-tab]').last();
      nextTab.click();
      $('.pusher').focus();
      break;

    case 39: // right
      nextTab = $('.tab-menu a[data-tab].active').next('a[data-tab]');
      if (!nextTab.length) nextTab = $('.tab-menu a[data-tab]').first();
      nextTab.click();
      $('.pusher').focus();
      break;
  }
});

    $(document).ready(function() {
  $('img').addClass('ui image');

  $('.ui.embed').embed();

  const $images = $('.lab img');
  jQuery.each($images, function(i) {
    if ($images[i].alt.length > 0) {
      const divImg = $(document.createElement('div')).addClass(
        'ui basic segment',
      );
      $($images[i]).wrap(divImg);
      const divLabel = $(document.createElement('div')).addClass(
        'ui blue ribbon label',
      );
      divLabel.append($images[i].alt);
      $(divLabel).insertBefore($images[i]);
    }
  });

  $('.ui.menu .item').tab({
    history: true,
    historyType: 'hash',
  });

  $('.popup').popup();

  $('.ui.sidebar')
    .sidebar({ context: $('.pushable') })
    .sidebar('setting', 'transition', 'slide out')
    .sidebar('attach events', '#toc');
});

  </script>



  <div class="ui bottom fixed borderless right menu">
    <div class="ui right small menu">
      <div class="ui tiny basic message segment">
         Powered by <a href="https://github.com/edeleastar/tutors-ts">tutors-ts.</a> Unless otherwise stated, this work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
      </div>
    </div>
  </div>

  </body>

</html>