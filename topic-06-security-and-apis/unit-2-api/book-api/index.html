<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet'>
    <link href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/combine/npm/highlightjs@9.16.2,npm/jquery@3.4.1"></script>
    <script src="https://cdn.jsdelivr.net/combine/npm/highlightjs@9.16.2,npm/jquery@3.4.1,npm/jquery-address@1.6.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.js"></script>
    <link href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.17.1/build/styles/railscasts.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.17.1/build/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <style>
      

body {
  font-family: "Open Sans", "Helvetica", "Helvetica Neue",  "Arial", sans-serif;
  font-size:90%;
  color: black;
}

p {
  margin: 0.5em;
}

pre code {
  font-family: "Monaco";
  font-size: 100%;
}

img {
  box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
  margin:10px;
}

h1, h2, h3 {
  border-bottom:thin solid black;
  margin-bottom: 0.5em;
  margin-top: 1em;
}

h1 {
  font-style:italic;
  font-size:130%;
}

h2 {
  font-size:110%;
}

h3 {
  font-size:100%;
}



      

html, body {
  height: 100%;
  margin: 0;
}
.wrapper {
  height: 100%;
  display: flex;
  flex-direction: column;
}
.footer {
  background: white;
  text-align: right;
}
.content {
  flex: 1;
  overflow: auto;
}



    </style>
  </head>

  
  

  <div class="ui fixed top pointing inverted stackable menu labmenu">
    <header class="header item">
      <i id="toc" class="sitemap icon"></i>
      
        <a href="../../index.html"> APIs  </a>
      
    </header>
    <div class="right tab-menu menu">
      
        <a class="item" data-tab="Lab 06b Apis">
          Lab 06b Apis
        </a>
      
        <a class="item" data-tab="01">
          01
        </a>
      
        <a class="item" data-tab="02">
          02
        </a>
      
        <a class="item" data-tab="03">
          03
        </a>
      
        <a class="item" data-tab="04">
          04
        </a>
      
        <a class="item" data-tab="05">
          05
        </a>
      
        <a class="item" data-tab="06">
          06
        </a>
      
        <a class="item" data-tab="07">
          07
        </a>
      
        <a class="item" data-tab="Exercises">
          Exercises
        </a>
      
    </div>
  </div>


  

  <div class="ui pushable">
    <div class="ui inverted labeled icon left inline vertical sidebar menu">
      <br><br>
      
        
          
            <a class="item"
               href="/topic-01-js-client/unit-1/book-3-jquery/index.html">Lab 01a JQuery </a>
          
        
      
        
          
            <a class="item"
               href="/topic-01-js-client/unit-2/book-1-ajax-1/index.html">Lab 01b Github API </a>
          
        
      
        
          
            <a class="item"
               href="/topic-02-introducing-node/unit-1/book-1/index.html">Lab 02a FoureSquare API </a>
          
        
      
        
          
            <a class="item"
               href="/topic-02-introducing-node/unit-1/book-2/index.html">Lab 02b FoureSquare JS </a>
          
        
      
        
          
            <a class="item"
               href="/topic-02-introducing-node/unit-2/book-applications/index.html">Lab 02b Applications </a>
          
        
      
        
          
            <a class="item"
               href="/topic-03-hapi-apps/unit-1-views/book-views/index.html">Lab 03a Views </a>
          
        
      
        
          
            <a class="item"
               href="/topic-03-hapi-apps/unit-2-sessions/book-sessions/index.html">Lab 03b Sessions </a>
          
        
      
        
          
            <a class="item"
               href="/topic-04-mongo-db/unit-1/book-models/index.html">Lab 04a Models I </a>
          
        
      
        
          
            <a class="item"
               href="/topic-04-mongo-db/unit-2/book-1/index.html">Lab-04b Models II </a>
          
        
      
        
          
            <a class="item"
               href="/topic-05-deployment-seeding/unit-0-validation/book-1-validation/index.html">Lab 05a Validation </a>
          
        
      
        
          
            <a class="item"
               href="/topic-05-deployment-seeding/unit-1-deployment/book-2-deployment/index.html">Lab 05b Deployment </a>
          
        
      
        
          
            <a class="item"
               href="/topic-05-deployment-seeding/unit-2-db-seeding/book-seeding/index.html">Lab 05c Seeding </a>
          
        
      
        
          
            <a class="item"
               href="/topic-06-security-and-apis/unit-1-security-introduction/book-1-pgp-gpg/index.html">Lab 06a GPG </a>
          
        
      
        
          
            <a class="item"
               href="/topic-06-security-and-apis/unit-2-api/book-api/index.html">Lab 06b Apis </a>
          
        
      
        
          
            <a class="item"
               href="/topic-07-security-and-tdd/unit-1-security-foundations/book-1-openssl/index.html">Lab 07a OpenSSL and Certificates </a>
          
        
      
        
          
            <a class="item"
               href="/topic-07-security-and-tdd/unit-2-tdd/book-tdd/index.html">Lab 07b Tdd </a>
          
        
      
        
          
            <a class="item"
               href="/topic-08-tls-threats/unit-1-certificates+tls/book-1-tls-configuration/index.html">Lab 08a TLS </a>
          
        
      
        
          
            <a class="item"
               href="/topic-08-tls-threats/unit-2-webapp-threats+vulnerabilities/book-1-misuse-cases/index.html">Lab 08b Threat Modelling </a>
          
        
      
        
          
            <a class="item"
               href="/topic-09-authentication-rest/unit-1-web-app-authentication/book-1-web-authentication/index.html">Lab 09a Authentication techniques </a>
          
        
      
        
          
            <a class="item"
               href="/topic-09-authentication-rest/unit-2-rest/book-rest/index.html">Lab 09b Rest </a>
          
        
      
        
          
            <a class="item"
               href="/topic-10-pen-testing-aurelia-1/unit-1-pentesting/book-1-burp-proxy/index.html">Lab 10a Burp-Proxy </a>
          
        
      
        
          
            <a class="item"
               href="/topic-10-pen-testing-aurelia-1/unit-1-pentesting/book-2-regex/index.html">Lab 10b Regular Expressions </a>
          
        
      
        
          
            <a class="item"
               href="/topic-10-pen-testing-aurelia-1/unit-1-pentesting/book-3-xss/index.html">Lab 10c XSS tips </a>
          
        
      
        
          
            <a class="item"
               href="/topic-10-pen-testing-aurelia-1/unit-2-aurelia-a/book-au-1/index.html">Lab-10d Aurelia Components </a>
          
        
      
        
          
            <a class="item"
               href="/topic-10-pen-testing-aurelia-1/unit-2-aurelia-b/book-au-2/index.html">Lab 10e Aurelia Custom Elements </a>
          
        
      
        
          
            <a class="item"
               href="/topic-11-aurelia-2/unit-0-routers/book-au-3/index.html">Lab 11a Aurelia Router </a>
          
        
      
        
          
            <a class="item"
               href="/topic-11-aurelia-2/unit-1-services/book-au-4/index.html">Lab 11b Aurelia Services </a>
          
        
      
        
          
            <a class="item"
               href="/topic-11-aurelia-2/unit-2-events/book-au-5/index.html">Lab 11c Aurelia Event Aggregator </a>
          
        
      
        
          
            <a class="item"
               href="/topic-11-aurelia-2/unit-3-aurelia-authentication-1/book-au-6/index.html">Lab 11d User Models </a>
          
        
      
        
          
            <a class="item"
               href="/topic-11-aurelia-2/unit-3-aurelia-authentication-1/book-au-7/index.html">Lab 11e donation-client:donation-web </a>
          
        
      
        
          
            <a class="item"
               href="/topic-12-aurelia-3/unit-1/book-a-hapi-auth/index.html">Lab 12a Hapi-JWT </a>
          
        
      
        
          
            <a class="item"
               href="/topic-12-aurelia-3/unit-1/book-b-aurelia-jwt/index.html">Lab-12b Aurelia JWT </a>
          
        
      
        
          
            <a class="item"
               href="/topic-12-aurelia-3/unit-2/book-1-maps/index.html">Lab-12c Map Panel </a>
          
        
      
        
          
            <a class="item"
               href="/topic-12-aurelia-3/unit-2/book-2-maps-2/index.html">Lab-12d Map View </a>
          
        
      
        
          
            <a class="item"
               href="/topic-12-aurelia-3/unit-2/book-3-deployment/index.html">Lab-12e Deployment </a>
          
        
      
    </div>
    <div class="pusher" tabindex="-1">
      <div class="ui basic segment">
        <br>
        
          <div class="ui tab segment lab" data-tab="Lab 06b Apis">
            <h1>Objectives</h1>
<p>Start the development of an API for the donation service, focusing initially on providing access to the Candidates model. Implement the API using simple REST principles.</p>

          </div>
        
          <div class="ui tab segment lab" data-tab="01">
            <h1>First Simple API Endpoint: Get All Candidates</h1>
<p>Introduce a new folder inside app called <code>api</code>, and place the following module in that folder:</p>
<h2>app/api/candidates.js</h2>
<pre><code>&#39;use strict&#39;;

const Candidate = require(&#39;../models/candidate&#39;);

const Candidates = {

  find: {
    auth: false,
    handler: async function(request, h) {
      const candidates = await Candidate.find();
      return candidates;
    }
  },
};

module.exports = Candidates;</code></pre>
<p>This handler returns all candidates, or a standard error message. Note that we have set no authentication:</p>
<pre><code>  auth: false,</code></pre>
<p>... which means that this call is open, and is not guarded by the session based authentication currently set as the default for our application.</p>
<h2>routesapi.js</h2>
<p>We new include a new routes file specifically to service the API routes:</p>
<pre><code>const Candidates = require(&#39;./app/api/candidates&#39;);

module.exports = [
  { method: &#39;GET&#39;, path: &#39;/api/candidates&#39;, config: Candidates.find }
];</code></pre>
<p>Place this in the root of the project, which should look like this now:</p>
<p><img src="img/04x.png" alt=""></p>
<h2>index.js</h2>
<p>Finally, we need to include this route into the application server - this is in <code>index.js</code> - we can add it after the inclusion of the UI routes we have created so far::</p>
<pre><code>  server.route(require(&#39;./routes&#39;));
  server.route(require(&#39;./routesapi&#39;));</code></pre>
<p>We can run the app now, and verify that the route can be accessed:</p>
<ul>
<li><a href="http://localhost:4000/api/candidates">http://localhost:4000/api/candidates</a></li>
</ul>
<p><img src="img/01.png" alt=""></p>
<p>We also can see the seeded objects in the webstorm console:</p>
<p><img src="img/02.png" alt=""></p>
<p>Note that these objects (including ids) should be identical.</p>

          </div>
        
          <div class="ui tab segment lab" data-tab="02">
            <h1>Get Candidate Endpoint</h1>
<p>The first endpoint we have just implemented retrieves all candidates. We can also introduce a route to retrieve a single candidate:</p>
<h2>routesapi.js</h2>
<pre><code>  { method: &#39;GET&#39;, path: &#39;/api/candidates/{id}&#39;, config: Candidates.findOne }</code></pre>
<h2>app/api/candidatesapi.js</h2>
<pre><code>  findOne: {
    auth: false,
    handler: async function(request, h) {
      const candidate = await Candidate.findOne({ _id: request.params.id });
      return candidate;
    }
  }</code></pre>
<p>In order to retrieve the candidate, we will need the ID for the candidate of interest:</p>
<ul>
<li><a href="http://localhost:3000/api/candidates/57b6bbd3a11377b03d31da0a">http://localhost:3000/api/candidates/57b6bbd3a11377b03d31da0a</a></li>
</ul>
<p><img src="img/05x.png" alt=""></p>
<p>The Id changes every time we launch the application, as our database seeder clears all collections each time. You can copy paste a valid ID from the start up console, where we have listed all seeded objects.</p>
<p>If we specify an unknown id, we will generate the this error:</p>
<pre><code>{
  statusCode: 500,
  error: &quot;Internal Server Error&quot;,
  message: &quot;An internal server error occurred&quot;
}</code></pre>
<p>This is not quite the correct response - which should be an official http <code>not found</code> error. We can generate this using the Boom library. Import this now:</p>
<pre><code>const Boom = require(&#39;boom&#39;);</code></pre>
<p>This is a revised version of the findOne handler:</p>
<pre><code>    handler: async function(request, h) {
      const candidate = await Candidate.findOne({ _id: request.params.id });
      if (!candidate) {
        return Boom.notFound(&#39;No Candidate with this id&#39;);
      }
      return candidate;
    }</code></pre>
<p>Try an incorrect id - make sure the test id is the same number of characters as a valid id. It should respond with:</p>
<pre><code>{
  statusCode: 404,
  error: &quot;Not Found&quot;,
  message: &quot;No Candidate with this id&quot;
}</code></pre>
<p>Now try an incorrect route - but this time an id for some random length. For example</p>
<p>Note also, that if we use an incorrect id - for instance:</p>
<ul>
<li><a href="http://localhost:3000/api/candidates/57b6bbd3a11377b0dfdfdf3d31da0a">http://localhost:3000/api/candidates/57b6bbd3a11377b0dfdfdf3d31da0a</a></li>
</ul>
<p>This will, however, yield:</p>
<pre><code>{
  statusCode: 500,
  error: &quot;Internal Server Error&quot;,
  message: &quot;An internal server error occurred&quot;
}</code></pre>
<p>This is a result of mongo throwing an exception when an invalid object id is supplied (incorrect length). The internal error will be something like:</p>
<pre><code>Cast to ObjectId failed for value &quot;5c725b31f8508df62d49fe60sfefgwg&quot; at path &quot;_id&quot; for model &quot;Candidate&quot;</code></pre>
<p>This is a revised version - which will generate a better error report in this circumstance:</p>
<pre><code>  findOne: {
    auth: false,
    handler: async function(request, h) {
      try {
        const candidate = await Candidate.findOne({ _id: request.params.id });
        if (!candidate) {
          return Boom.notFound(&#39;No Candidate with this id&#39;);
        }
        return candidate;
      } catch (err) {
        return Boom.notFound(&#39;No Candidate with this id&#39;);
      }
    }
  }</code></pre>
<p>Verify that you get a 404 now with an invalid id.</p>

          </div>
        
          <div class="ui tab segment lab" data-tab="03">
            <h1>Testing the Endpoints: Postman</h1>
<p>Using a browser to retrieve and verify the behaviour of api endpoints is a useful sanity check, but not viable as our endpoints become more sophisticated.</p>
<p>This is a popular tool for exercising these endpoints:</p>
<ul>
<li><a href="https://www.getpostman.com/">https://www.getpostman.com/</a></li>
</ul>
<p>Install the standalone version now. We will make use of it occasionally as we devise more interesting api endpoints:</p>
<p>Build some request now for one of our endpoints:</p>
<p><img src="img/08x.png" alt=""></p>
<p>You can save and organise requests into collections:</p>
<p><img src="img/10x.png" alt=""></p>
<p>This can be useful for exercising more complex APIs</p>

          </div>
        
          <div class="ui tab segment lab" data-tab="04">
            <h1>Testing the Endpoints: TDD Tools</h1>
<p>Although Postman is useful for exploratory development, developing APIs requires a more robust testing strategy. This is the realm of Test Driven Development:</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Test-driven_development">https://en.wikipedia.org/wiki/Test-driven_development</a></li>
</ul>
<p>Facilitated by specialized tools and techniques. The most fundamental set of tools are based around the so-called <code>X-Unit</code> pattern:</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/XUnit">https://en.wikipedia.org/wiki/XUnit</a></li>
</ul>
<p>We are going to use these two X-Unit related tools:</p>
<ul>
<li><a href="https://mochajs.org/">https://mochajs.org/</a></li>
<li><a href="http://chaijs.com/">http://chaijs.com/</a></li>
</ul>
<p>To use these tools, we need install both extensions to our WebStorm IDE and also the appropriate javascript libraries.</p>
<p>Mocha support should already be part of your WebStorm installation:</p>
<p><img src="img/11x.png" alt=""></p>
<p>We will explore this in a moment.</p>
<p>To make use of TDD in our app, we need to instal the mocha and chai modules:</p>
<pre><code>npm install mocha -save-dev
npm install chai -save-dev</code></pre>
<p>Node the <code>-save-dev</code> switch. This establishes the libraries as development, not production, libraries - required only for dev/test purposes. </p>
<p>Package.json includes these references in a separate section:</p>
<pre><code>{
  &quot;name&quot;: &quot;donation-web&quot;,
  &quot;version&quot;: &quot;1.0.0&quot;,
  &quot;description&quot;: &quot;&quot;,
  &quot;main&quot;: &quot;index.js&quot;,
  &quot;scripts&quot;: {
    &quot;start&quot;: &quot;node index.js&quot;,
    &quot;test&quot;: &quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;
  },
  &quot;author&quot;: &quot;&quot;,
  &quot;license&quot;: &quot;ISC&quot;,
  &quot;dependencies&quot;: {
    &quot;boom&quot;: &quot;^7.3.0&quot;,
    &quot;dotenv&quot;: &quot;^6.2.0&quot;,
    &quot;handlebars&quot;: &quot;^4.0.12&quot;,
    &quot;hapi&quot;: &quot;^18.0.0&quot;,
    &quot;hapi-auth-cookie&quot;: &quot;^9.1.0&quot;,
    &quot;inert&quot;: &quot;^5.1.2&quot;,
    &quot;joi&quot;: &quot;^14.3.1&quot;,
    &quot;mais-mongoose-seeder&quot;: &quot;^1.0.7&quot;,
    &quot;mongoose&quot;: &quot;^5.4.7&quot;,
    &quot;vision&quot;: &quot;^5.4.4&quot;
  },
  &quot;devDependencies&quot;: {
    &quot;chai&quot;: &quot;^4.2.0&quot;,
    &quot;mocha&quot;: &quot;^6.0.1&quot;,
    &quot;prettier&quot;: &quot;^1.16.0&quot;
  },
  &quot;prettier&quot;: {
    &quot;singleQuote&quot;: true,
    &quot;printWidth&quot;: 120
  }
}</code></pre>

          </div>
        
          <div class="ui tab segment lab" data-tab="05">
            <h1>First Simple Test</h1>
<p>Create a new folder in your project called <code>test</code> and create <code>candidateapitest.js</code> module:</p>
<p><img src="img/12x.png" alt=""></p>
<h2>test/candidateapitest.js</h2>
<pre><code>&#39;use strict&#39;;

const assert = require(&#39;chai&#39;).assert;

suite(&#39;Candidate API tests&#39;, function () {

  test(&#39;get candidates&#39;, function () {

    assert.equal(1, 1);

  });
});</code></pre>
<p>This is a simple test, guaranteed to succeed. </p>
<p>In order to run it, select the file and select run from the context menu. We should see the built in Mocha test runner:</p>
<p><img src="img/13x.png" alt=""></p>
<p>If your WebStorm installation does not auto generate the above run configuration, you may need to manually establish a run configuration in the IDE:</p>
<p><img src="img/14x.png" alt=""></p>
<p>In order to gain familiarity with the Mochal test runner, change the assert to be guaranteed to fail:</p>
<pre><code>    assert.equal(1, 10);</code></pre>
<p>Now rerun the test - this is how test failures are reported:</p>
<p><img src="img/15x.png" alt=""></p>

          </div>
        
          <div class="ui tab segment lab" data-tab="06">
            <h1>First Mocha API Test</h1>
<p>We can now compose a test, entirely in javascript, to exercise the api we have just created. First, we need a http client:</p>
<ul>
<li><a href="https://github.com/axios/axios">https://github.com/axios/axios</a></li>
</ul>
<p>Install this in the project now:</p>
<pre><code>npm install axios -save-dev</code></pre>
<p>Now a new version of the test:</p>
<h2>test/candidateapitest.js</h2>
<pre><code>&#39;use strict&#39;;

const assert = require(&#39;chai&#39;).assert;
const axios = require(&#39;axios&#39;);

suite(&#39;Candidate API tests&#39;, function () {

  test(&#39;get candidates&#39;, async function () {
    const response = await axios.get(&#39;http://localhost:3000/api/candidates&#39;);
    console.log(response.data);
  });
});</code></pre>
<p>Running the test will echo the returned candidates:</p>
<p><img src="img/16x.png" alt=""></p>
<p>All tests should have assertions, and rarely would we make use of the console. Replace the test body with the following:</p>
<pre><code>  test(&#39;get candidates&#39;, async function () {
    const response = await axios.get(&#39;http://localhost:3000/api/candidates&#39;);
    const candidates = response.data;
    assert.equal(2, candidates.length);
  });</code></pre>
<p>This test should pass. How do we know there are exactly two candidates? Recall that we seeded the database with the contents of <code>app/models/initdata.json</code></p>
<pre><code>{
  &quot;users&quot;: {
    &quot;_model&quot;: &quot;User&quot;,
    &quot;homer&quot;: {
      &quot;firstName&quot;: &quot;Homer&quot;,
      &quot;lastName&quot;: &quot;Simpson&quot;,
      &quot;email&quot;: &quot;homer@simpson.com&quot;,
      &quot;password&quot;: &quot;secret&quot;
    },
    &quot;marge&quot;: {
      &quot;firstName&quot;: &quot;Marge&quot;,
      &quot;lastName&quot;: &quot;Simpson&quot;,
      &quot;email&quot;: &quot;marge@simpson.com&quot;,
      &quot;password&quot;: &quot;secret&quot;
    },
    &quot;bart&quot;: {
      &quot;firstName&quot;: &quot;Bart&quot;,
      &quot;lastName&quot;: &quot;Simpson&quot;,
      &quot;email&quot;: &quot;bart@simpson.com&quot;,
      &quot;password&quot;: &quot;secret&quot;
    }
  },
  &quot;candidates&quot;: {
    &quot;_model&quot;: &quot;Candidate&quot;,
    &quot;lisa&quot;: {
      &quot;firstName&quot;: &quot;Lisa&quot;,
      &quot;lastName&quot;: &quot;Simpson&quot;,
      &quot;office&quot;: &quot;President&quot;
    },
    &quot;donald&quot;: {
      &quot;firstName&quot;: &quot;Donald&quot;,
      &quot;lastName&quot;: &quot;Simpson&quot;,
      &quot;office&quot;: &quot;President&quot;
    }
  },
  &quot;donations&quot;: {
    &quot;_model&quot;: &quot;Donation&quot;,
    &quot;one&quot;: {
      &quot;amount&quot;: 40,
      &quot;method&quot;: &quot;paypal&quot;,
      &quot;donor&quot;: &quot;-&gt;users.bart&quot;,
      &quot;candidate&quot;: &quot;-&gt;candidates.lisa&quot;
    },
    &quot;two&quot;: {
      &quot;amount&quot;: 90,
      &quot;method&quot;: &quot;direct&quot;,
      &quot;donor&quot;: &quot;-&gt;users.marge&quot;,
      &quot;candidate&quot;: &quot;-&gt;candidates.lisa&quot;
    },
    &quot;three&quot;: {
      &quot;amount&quot;: 430,
      &quot;method&quot;: &quot;paypal&quot;,
      &quot;donor&quot;: &quot;-&gt;users.homer&quot;,
      &quot;candidate&quot;: &quot;-&gt;candidates.donald&quot;
    }
  }
}</code></pre>
<p>We can extend the test to make sure we actually retrieve the candidates as specified in the above data set:</p>
<pre><code>  test(&#39;get candidates&#39;, async function () {
    const response = await axios.get(&#39;http://localhost:3000/api/candidates&#39;);
    const candidates = response.data;
    assert.equal(2, candidates.length);

    assert.equal(candidates[0].firstName, &#39;Lisa&#39;);
    assert.equal(candidates[0].lastName, &#39;Simpson&#39;);
    assert.equal(candidates[0].office, &#39;President&#39;);

    assert.equal(candidates[1].firstName, &#39;Donald&#39;);
    assert.equal(candidates[1].lastName, &#39;Simpson&#39;);
    assert.equal(candidates[1].office, &#39;President&#39;);
  });</code></pre>
<p>This test should pass.</p>
<p>Testing our second route involves a little more work, as we have to request a single candidate by an ID. We get this ID from the request for all candidates.</p>
<p>This new test demonstrates the technique:</p>
<pre><code>   test(&#39;get one candidate&#39;, async function () {
    let response = await axios.get(&#39;http://localhost:3000/api/candidates&#39;);
    const candidates = response.data;
    assert.equal(2, candidates.length);

    const oneCandidateUrl = &#39;http://localhost:3000/api/candidates/&#39; + candidates[0]._id;
    response = await axios.get(oneCandidateUrl);
    const oneCandidate = response.data;

    assert.equal(oneCandidate.firstName, &#39;Lisa&#39;);
    assert.equal(oneCandidate.lastName, &#39;Simpson&#39;);
    assert.equal(oneCandidate.office, &#39;President&#39;);
  });</code></pre>
<p>Verify now that out two tests pass:</p>
<pre><code>&#39;use strict&#39;;

const assert = require(&#39;chai&#39;).assert;
const axios = require(&#39;axios&#39;);

suite(&#39;Candidate API tests&#39;, function () {

  test(&#39;get candidates&#39;, async function () {
    const response = await axios.get(&#39;http://localhost:3000/api/candidates&#39;);
    const candidates = response.data;
    assert.equal(2, candidates.length);

    assert.equal(candidates[0].firstName, &#39;Lisa&#39;);
    assert.equal(candidates[0].lastName, &#39;Simpson&#39;);
    assert.equal(candidates[0].office, &#39;President&#39;);

    assert.equal(candidates[1].firstName, &#39;Donald&#39;);
    assert.equal(candidates[1].lastName, &#39;Simpson&#39;);
    assert.equal(candidates[1].office, &#39;President&#39;);
  });

  test(&#39;get one candidate&#39;, async function () {
    let response = await axios.get(&#39;http://localhost:3000/api/candidates&#39;);
    const candidates = response.data;
    assert.equal(2, candidates.length);

    const oneCandidateUrl = &#39;http://localhost:3000/api/candidates/&#39; + candidates[0]._id;
    response = await axios.get(oneCandidateUrl);
    const oneCandidate = response.data;

    assert.equal(oneCandidate.firstName, &#39;Lisa&#39;);
    assert.equal(oneCandidate.lastName, &#39;Simpson&#39;);
    assert.equal(oneCandidate.office, &#39;President&#39;);
  });
});</code></pre>
<p><img src="img/18x.png" alt=""></p>

          </div>
        
          <div class="ui tab segment lab" data-tab="07">
            <h1>Create and Delete Candidate Endpoints</h1>
<p>We can also define a routes to update the candidates collection:</p>
<h2>routesapi.js</h2>
<pre><code>  { method: &#39;POST&#39;, path: &#39;/api/candidates&#39;, config: CandidatesApi.create },
  { method: &#39;DELETE&#39;, path: &#39;/api/candidates/{id}&#39;, config: CandidatesApi.deleteOne },
  { method: &#39;DELETE&#39;, path: &#39;/api/candidates&#39;, config: CandidatesApi.deleteAll },</code></pre>
<ul>
<li>The first route will be used to create a single candidate</li>
<li>The second route delete a single candidate (id must be provided)</li>
<li>The third route deletes all candidates</li>
</ul>
<p>These are the implementations of the handlers for these routes:</p>
<h2> </h2>
<pre><code>  create: {
    auth: false,
    handler: async function(request, h) {
      const newCandidate = new Candidate(request.payload);
      const candidate = await newCandidate.save();
      if (candidate) {
        return h.response(candidate).code(201);
      }
      return Boom.badImplementation(&#39;error creating candidate&#39;);
    }
  },

  deleteAll: {
    auth: false,
    handler: async function(request, h) {
      await Candidate.remove({});
      return { success: true };
    }
  },

  deleteOne: {
    auth: false,
    handler: async function(request, h) {
      const candidate = await Candidate.remove({ _id: request.params.id });
      if (candidate) {
        return { success: true };
      }
      return Boom.notFound(&#39;id not found&#39;);
    }
  }</code></pre>
<p>These routes cannot be considered complete until a set of tests verify their operation.</p>
<p>Here is a test to verify operation of the Create Candidate route:</p>
<pre><code>  test(&#39;create a candidate&#39;, async function () {
    const candidatesUrl = &#39;http://localhost:3000/api/candidates&#39;;
    const newCandidate = {
      firstName: &#39;Barnie&#39;,
      lastName: &#39;Grumble&#39;,
      office: &#39;President&#39;,
    };

    const response = await axios.post(candidatesUrl, newCandidate);
    const returnedCandidate = response.data;
    assert.equal(201, response.status);

    assert.equal(returnedCandidate.firstName, &#39;Barnie&#39;);
    assert.equal(returnedCandidate.lastName, &#39;Grumble&#39;);
    assert.equal(returnedCandidate.office, &#39;President&#39;);
  });</code></pre>
<p>Note how to invoke a <code>POST</code> route using our sync-request library:</p>
<pre><code>    const newCandidate = {
      firstName: &#39;Barnie&#39;,
      lastName: &#39;Grumble&#39;,
      office: &#39;President&#39;,
    };

    const response = await axios.post(candidatesUrl, newCandidate);</code></pre>
<p>Run this test now and verify that is passes.</p>

          </div>
        
          <div class="ui tab segment lab" data-tab="Exercises">
            <h1>Exercises</h1>
<p>Archive of the project so far:</p>
<ul>
<li><a href="https://github.com/wit-hdip-comp-sci-2018/donation-web/releases/tag/donation.10.end">https://github.com/wit-hdip-comp-sci-2018/donation-web/releases/tag/donation.10.end</a></li>
</ul>
<h2>Exercise 1:</h2>
<p>You may notice that some of the other tests are a bit fragile - as they may fail of the server is not restarted. See if you can rethink the tests such that they always run successfully.</p>
<h2>Exercise 2 : Additional Unit Tests</h2>
<p>Write tests for the untested endpoints:</p>
<ul>
<li>delete a singe candidate</li>
<li>delete all candidates</li>
</ul>
<h2>Exercise 3: Postman</h2>
<p>Postman can be used to test these new <code>POST</code> and <code>DELETE</code>routes. Try to figure out how to do this.</p>
<p>HINT: Below is an example of a successful create candidate endpoint request:</p>
<p><img src="img/17x.png" alt=""></p>
<p>You will need to spend some time configuring the options and parameters for the request. Most of these are visible on the above screen shot.</p>

          </div>
        
      </div>
    </div>
  </div>


  <br>
  <script>
    $(document).on('keydown', function(e) {
  e = e || window.event;
  var nextTab;
  switch (e.which || e.keyCode) {
    case 37: // left
      nextTab = $('.tab-menu a[data-tab].active').prev('a[data-tab]');
      if (!nextTab.length) nextTab = $('.tab-menu a[data-tab]').last();
      nextTab.click();
      $('.pusher').focus();
      break;

    case 39: // right
      nextTab = $('.tab-menu a[data-tab].active').next('a[data-tab]');
      if (!nextTab.length) nextTab = $('.tab-menu a[data-tab]').first();
      nextTab.click();
      $('.pusher').focus();
      break;
  }
});

    $(document).ready(function() {
  $('img').addClass('ui image');

  $('.ui.embed').embed();

  const $images = $('.lab img');
  jQuery.each($images, function(i) {
    if ($images[i].alt.length > 0) {
      const divImg = $(document.createElement('div')).addClass(
        'ui basic segment',
      );
      $($images[i]).wrap(divImg);
      const divLabel = $(document.createElement('div')).addClass(
        'ui blue ribbon label',
      );
      divLabel.append($images[i].alt);
      $(divLabel).insertBefore($images[i]);
    }
  });

  $('.ui.menu .item').tab({
    history: true,
    historyType: 'hash',
  });

  $('.popup').popup();

  $('.ui.sidebar')
    .sidebar({ context: $('.pushable') })
    .sidebar('setting', 'transition', 'slide out')
    .sidebar('attach events', '#toc');
});

  </script>



  <div class="ui bottom fixed borderless right menu">
    <div class="ui right small menu">
      <div class="ui tiny basic message segment">
         Powered by <a href="https://github.com/edeleastar/tutors-ts">tutors-ts.</a> Unless otherwise stated, this work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
      </div>
    </div>
  </div>

  </body>

</html>